name: Build Windows EXE (Single File)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install PyQt5
        pip install -r requirements.txt
    
    - name: Download AI Models
      run: |
        echo "Downloading AI models..."
        mkdir models
        set HF_ENDPOINT=https://hf-mirror.com
        python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('all-MiniLM-L6-v2', cache_folder='models')"
        python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('cross-encoder/ms-marco-MiniLM-L-6-v2', cache_folder='models/cross-encoder_ms-marco-MiniLM-L-6-v2')"
        echo "Models downloaded"
        dir models
    
    - name: Build Single EXE
      shell: bash
      run: |
        echo "Building single EXE file..."
        
        pyinstaller desktop_app.py \
          --name "参考文献反插助手" \
          --onefile \
          --windowed \
          --add-data "src:src" \
          --add-data "config:config" \
          --add-data "models:models" \
          --collect-all PyQt5 \
          --collect-all sentence_transformers \
          --hidden-import src.literature.db_manager \
          --hidden-import src.draft.analyzer \
          --hidden-import src.draft.context_understanding \
          --hidden-import src.citation.matcher \
          --hidden-import src.citation.ai_matcher \
          --hidden-import src.citation.search_engine \
          --hidden-import src.citation.rag_retriever \
          --hidden-import src.citation.vector_search \
          --hidden-import src.citation.format_learner \
          --hidden-import src.utils.config
        
        echo "Single EXE build completed"
      timeout-minutes: 40
    
    - name: Check output
      shell: bash
      run: |
        echo "Dist folder contents:"
        ls -lh dist/
        echo ""
        if [ -f "dist/参考文献反插助手.exe" ]; then
          echo "SUCCESS: Found single EXE file!"
          ls -lh "dist/参考文献反插助手.exe"
        else
          echo "Warning: EXE file not found"
        fi
    
    - name: Upload single EXE
      uses: actions/upload-artifact@v4
      with:
        name: Single-EXE-Version
        path: dist/参考文献反插助手.exe
        if-no-files-found: error
        retention-days: 30
