name: Build Windows EXE (Simple)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install PyQt5
        pip install -r requirements.txt
    
    - name: Download AI Models
      run: |
        echo "Downloading AI models..."
        mkdir models
        set HF_ENDPOINT=https://hf-mirror.com
        python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('all-MiniLM-L6-v2', cache_folder='models')"
        python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('cross-encoder/ms-marco-MiniLM-L-6-v2', cache_folder='models/cross-encoder_ms-marco-MiniLM-L-6-v2')"
        echo "Models downloaded"
        dir models
    
    - name: Build EXE (Desktop Version)
      shell: bash
      run: |
        echo "Starting desktop build..."
        
        pyinstaller desktop_app.py \
          --name "参考文献反插助手" \
          --onedir \
          --console \
          --add-data "src:src" \
          --add-data "config:config" \
          --add-data "models:models" \
          --collect-all PyQt5 \
          --collect-all sentence_transformers \
          --hidden-import src.literature.db_manager \
          --hidden-import src.draft.analyzer \
          --hidden-import src.draft.context_understanding \
          --hidden-import src.citation.matcher \
          --hidden-import src.citation.ai_matcher \
          --hidden-import src.citation.search_engine \
          --hidden-import src.citation.rag_retriever \
          --hidden-import src.citation.vector_search \
          --hidden-import src.citation.format_learner \
          --hidden-import src.utils.config
        echo "Desktop build completed"
      timeout-minutes: 40
    
    - name: Verify build
      shell: bash
      run: |
        echo "Build output:"
        ls -la dist/
        echo "Checking for executable:"
        if [ -d "dist/参考文献反插助手" ]; then
          echo "Found 参考文献反插助手 folder"
          ls -la "dist/参考文献反插助手/"
        else
          echo "Warning: folder not found"
          ls -la dist/
        fi
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: PaperCitation-Helper-Windows
        path: |
          dist/参考文献反插助手/**
          !dist/参考文献反插助手/**/*.pyc
          !dist/参考文献反插助手/**/__pycache__/**
        if-no-files-found: warn
        retention-days: 30
